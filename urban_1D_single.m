%Setting the parameters here
Dw=2.0;%5.777341629741255 below this value - super(2.0), above - sub(6.5)
Dv=Dw;
ubar=0.5;
alpha=0.1;
Du=(1/32).*Dw.^(-2).*ubar.^(-1).*(16.*alpha.*Dw+(-8).*alpha.*Dw.^2+ ...
  2.*alpha.*ubar+(-16).*Dw.*ubar+(-1).*alpha.*Dw.*ubar+(-2).* ...
  ubar.^2+Dw.*ubar.^2)+(1/32).*(Dw.^(-4).*ubar.^(-2).*(512.* ...
  alpha.^2.*Dw.^2+(-256).*alpha.^2.*Dw.^3+64.*alpha.^2.*Dw.*ubar+( ...
  -1024).*alpha.*Dw.^2.*ubar+(-64).*alpha.^2.*Dw.^2.*ubar+256.* ...
  alpha.*Dw.^3.*ubar+16.*alpha.^2.*Dw.^3.*ubar+4.*alpha.^2.*ubar.^2+ ...
  (-128).*alpha.*Dw.*ubar.^2+(-4).*alpha.^2.*Dw.*ubar.^2+512.* ...
  Dw.^2.*ubar.^2+96.*alpha.*Dw.^2.*ubar.^2+alpha.^2.*Dw.^2.*ubar.^2+ ...
  (-16).*alpha.*Dw.^3.*ubar.^2+(-8).*alpha.*ubar.^3+64.*Dw.*ubar.^3+ ...
  8.*alpha.*Dw.*ubar.^3+(-32).*Dw.^2.*ubar.^3+(-2).*alpha.*Dw.^2.* ...
  ubar.^3+4.*ubar.^4+(-4).*Dw.*ubar.^4+Dw.^2.*ubar.^4)).^(1/2);
beta = (-1).*Du.^(-1).*ubar.^(-2).*((-2).*alpha.^2+(-1).*alpha.^2.*Dv+4.* ...
  alpha.*ubar+alpha.*Dv.*ubar+(-8).*alpha.*Du.*Dv.*ubar+(-2).* ...
  ubar.^2+8.*Du.*Dv.*ubar.^2);
%}
vbar= 1-alpha/ubar;
wbar = ubar*(beta/(ubar-alpha)-1);

K=(1/2).*Du.^(-1).*Dv.^(-1).*ubar.^(-1).*((-1).*alpha+ubar).^(-1).*( ...
  alpha.^2.*(2+Dv)+(-1).*alpha.*(4+Dv).*ubar+(2+(-1).*beta.*Du).* ...
  ubar.^2);
chi=Dw.*(alpha+beta+(-1).*ubar).^(-1).*(alpha+Du.*Dv.*K.^2+(-1).*ubar+ ...
  (-1).*alpha.*beta.*((-1).*alpha+ubar).^(-1));

wk=sqrt(K);
a = 0; 
b = 4*pi/wk;  
L = b-a;
N = 1001;
eps = 0.01;
%these are coefficients for the ODE and the initial conditions
Q=(1/2).*Dv.^(-1).*ubar.^(-2).*((-1).*alpha+ubar).^(-1).*((-1).* ...
  alpha.^2.*((-2)+Dv)+alpha.*((-4)+Dv).*ubar+(2+(-1).*beta.*Du).* ...
  ubar.^2);

R=(1/4).*Du.^(-1).*Dv.^(-1).*ubar.^(-2).*((-1).*alpha+ubar).^(-3).*( ...
  alpha.^4.*(2+Dv).^2+(-2).*alpha.^3.*(8+6.*Dv+Dv.^2).*ubar+ ...
  alpha.^2.*(24+2.*beta.*Du.*((-2)+Dv)+4.*(3+alpha.*Du).*Dv+Dv.^2).* ...
  ubar.^2+(-2).*alpha.*(beta.*Du.*((-4)+Dv)+2.*(4+Dv+3.*alpha.*Du.* ...
  Dv)).*ubar.^3+(4+(-4).*beta.*Du+beta.^2.*Du.^2+12.*alpha.*Du.*Dv) ...
  .*ubar.^4+(-4).*Du.*Dv.*ubar.^5);

C2=Du.^(-2).*Dv.^(-1).*K.^(-2).*ubar.^(-2).*((-1).*alpha+ubar).^(-1) ...
  .*(alpha.*(2+Dv)+2.*((-1)+Du.*Dv.*K).*ubar+Du.*ubar.^2).^(-1).*( ...
  alpha.^3.*(2+Dv).^2.*(1+8.*Du.*K)+alpha.^2.*(2+Dv).*((-4)+(-2).* ...
  Du.*(18+Dv).*K+Du.^2.*(8+25.*Dv).*K.^2).*ubar+alpha.*(4+8.*Du.*(6+ ...
  Dv).*K+(-1).*Du.^2.*(32+76.*Dv+13.*Dv.^2).*K.^2+20.*Du.^3.*Dv.*(1+ ...
  Dv).*K.^3+alpha.*Du.*(2+Dv).*(1+8.*Du.*K)).*ubar.^2+Du.*(K.*((-8)+ ...
  2.*Du.*(8+9.*Dv).*K+(-10).*Du.^2.*Dv.*(2+Dv).*K.^2+3.*Du.^3.* ...
  Dv.^2.*K.^3)+alpha.*(4.*Du.*K.*((-5)+2.*Du.*K)+Dv.*(1+(-4).*Du.*K+ ...
  9.*Du.^2.*K.^2))).*ubar.^3+Du.*((-2)+2.*Du.*(2+Dv).*K+(-1).* ...
  Du.^2.*(8+3.*Dv).*K.^2+2.*Du.^3.*Dv.*K.^3).*ubar.^4); ...
  

D11=(-1).*K.*((-1).*alpha+ubar).*(alpha.*(2+Dv)+2.*((-1)+Du.*Dv.*K).* ...
  ubar+Du.*ubar.^2).*((-1).*alpha.^2.*(2+Dv)+alpha.*(2+(-1).*(2+Dv) ...
  .*Dw.*K+Du.*((-2).*Dv+Dw).*K).*ubar+(-1).*(alpha.*Du+K.*(Du.^2.* ...
  Dv.*K+Dw.*((-2)+(-1).*Du.^2.*K+Du.*Dv.*K))).*ubar.^2+Du.*ubar.^3) ...
  .^(-1);


D13=(1/72).*Dw.*K.*ubar.^(-1).*((-1).*alpha+ubar).^(-2).*(alpha.*(2+ ...
  Dv)+2.*((-1)+Du.*Dv.*K).*ubar+Du.*ubar.^2).^(-1).*((-1).* ...
  alpha.^2.*(2+Dv)+alpha.*(2+(-1).*(2+Dv).*Dw.*K+Du.*((-2).*Dv+Dw).* ...
  K).*ubar+(-1).*(alpha.*Du+K.*(Du.^2.*Dv.*K+Dw.*((-2)+(-1).*Du.^2.* ...
  K+Du.*Dv.*K))).*ubar.^2+Du.*ubar.^3).^(-1).*(18.*alpha.^4.*(2+Dv) ...
  .^2.*(4+37.*Du.*K)+(-1).*alpha.^3.*(2+Dv).*(alpha.*C2.*(2+Dv).*(1+ ...
  2.*Du.*K)+18.*(20+224.*Du.*K+(-44).*Du.^2.*K.^2+Dv.*(2+40.*Du.*K+( ...
  -119).*Du.^2.*K.^2))).*ubar+alpha.^2.*(alpha.*(2+Dv).*(18.*Du.*(4+ ...
  37.*Du.*K)+C2.*(6+Dv+4.*Du.*K+(-5).*Du.*Dv.*K+4.*Du.^2.*K.^2+80.* ...
  Du.^2.*Dv.*K.^2))+18.*(Du.*Dv.^2.*K.*(16+(-149).*Du.*K+108.* ...
  Du.^2.*K.^2)+4.*(8+123.*Du.*K+(-57).*Du.^2.*K.^2+2.*Du.^3.*K.^3)+ ...
  2.*Dv.*(4+104.*Du.*K+(-283).*Du.^2.*K.^2+64.*Du.^3.*K.^3))).* ...
  ubar.^2+(-1).*alpha.*(alpha.^2.*C2.*Du.*(2+Dv).*(1+2.*Du.*K)+(-18) ...
  .*((-8)+(-4).*Du.*(58+13.*Dv).*K+2.*Du.^2.*(96+184.*Dv+31.*Dv.^2) ...
  .*K.^2+(-2).*Du.^3.*(8+96.*Dv+57.*Dv.^2).*K.^3+Du.^4.*Dv.*(18+31.* ...
  Dv).*K.^4)+alpha.*((-18).*Du.*((-4)+(-158).*Du.*K+44.*Du.^2.*K.^2+ ...
  Dv.*(2+(-52).*Du.*K+45.*Du.^2.*K.^2))+C2.*(Du.*Dv.^2.*K.*((-7)+ ...
  166.*Du.*K+(-172).*Du.^2.*K.^2)+12.*(1+(-2).*Du.*K+2.*Du.^2.*K.^2) ...
  +(-4).*Dv.*((-1)+9.*Du.*K+(-124).*Du.^2.*K.^2+4.*Du.^3.*K.^3)))).* ...
  ubar.^3+(alpha.^2.*C2.*Du.*(2+(-3).*Du.*Dv.*K+4.*Du.^2.*(1+21.*Dv) ...
  .*K.^2)+18.*Du.*K.*(40+(-4).*Du.*(13+21.*Dv).*K+4.*Du.^2.*(2+16.* ...
  Dv+11.*Dv.^2).*K.^2+(-9).*Du.^3.*Dv.*(2+Dv).*K.^3+5.*Du.^4.* ...
  Dv.^2.*K.^4)+2.*alpha.*(C2.*(2+(-1).*Du.*(20+11.*Dv).*K+Du.^2.*( ...
  12+250.*Dv+43.*Dv.^2).*K.^2+(-2).*Du.^3.*Dv.*(8+81.*Dv).*K.^3+9.* ...
  Du.^4.*Dv.^2.*K.^4)+9.*Du.*(2.*((-5)+55.*Du.*K+(-37).*Du.^2.*K.^2+ ...
  2.*Du.^3.*K.^3)+Dv.*((-3)+33.*Du.*K+(-49).*Du.^2.*K.^2+14.*Du.^3.* ...
  K.^3)))).*ubar.^4+Du.*(18.*(6+(-2).*Du.*(13+3.*Dv).*K+2.*Du.^2.*( ...
  15+11.*Dv).*K.^2+(-2).*Du.^3.*(2+Dv).*K.^3+3.*Du.^4.*Dv.*K.^4)+( ...
  -2).*C2.*K.*((-8)+(-4).*Du.^2.*Dv.*(2+19.*Dv).*K.^2+9.*Du.^3.* ...
  Dv.^2.*K.^3+4.*Du.*(K+21.*Dv.*K))+alpha.*C2.*(2+12.*Du.*K+(-8).* ...
  Du.^2.*K.^2+Dv.*(1+3.*Du.*K+(-171).*Du.^2.*K.^2+4.*Du.^3.*K.^3))) ...
  .*ubar.^5+C2.*Du.*((-2)+2.*Du.*((-4)+Dv).*K+Du.^2.*(4+87.*Dv).* ...
  K.^2+(-4).*Du.^3.*Dv.*K.^3).*ubar.^6);



C3=(1/8).*Du.^(-2).*Dv.^(-1).*K.^(-2).*ubar.^(-3).*((-1).*alpha+ubar) ...
  .^(-2).*(alpha.*(2+Dv)+2.*((-1)+Du.*Dv.*K).*ubar+Du.*ubar.^2).^( ...
  -1).*(2.*alpha.^4.*(2+Dv).^2.*((-4)+25.*Du.*K)+alpha.^3.*(2+Dv).*( ...
  alpha.*C2.*(2+Dv).*(1+18.*Du.*K)+(-8).*((-3)+56.*Du.*K+5.*Du.^2.* ...
  K.^2)+Dv.*((-4)+(-208).*Du.*K+70.*Du.^2.*K.^2)).*ubar+alpha.^2.*(( ...
  -2).*(12.*Du.*K.*((-53)+3.*Du.*K+6.*Du.^2.*K.^2)+Du.*Dv.^2.*K.*(( ...
  -40)+265.*Du.*K+68.*Du.^2.*K.^2)+2.*Dv.*((-4)+(-216).*Du.*K+251.* ...
  Du.^2.*K.^2+76.*Du.^3.*K.^3))+alpha.*(2+Dv).*(2.*Du.*((-4)+25.* ...
  Du.*K)+C2.*((-6)+(-116).*Du.*K+36.*Du.^2.*K.^2+Dv.*((-1)+(-27).* ...
  Du.*K+68.*Du.^2.*K.^2)))).*ubar.^2+alpha.*((-16)+(-8).*Du.*(82+ ...
  25.*Dv).*K+4.*Du.^2.*(96+292.*Dv+67.*Dv.^2).*K.^2+(-4).*Du.^3.*(( ...
  -72)+(-32).*Dv+69.*Dv.^2).*K.^3+(-6).*Du.^4.*Dv.*(26+31.*Dv).* ...
  K.^4+alpha.^2.*C2.*Du.*(2+Dv).*(1+18.*Du.*K)+(-2).*alpha.*Du.*(4+ ...
  198.*Du.*K+20.*Du.^2.*K.^2+3.*Dv.*(2+36.*Du.*K+5.*Du.^2.*K.^2))+ ...
  alpha.*C2.*(12+264.*Du.*K+(-216).*Du.^2.*K.^2+Du.*Dv.^2.*K.*(9+( ...
  -118).*Du.*K+60.*Du.^2.*K.^2)+4.*Dv.*(1+31.*Du.*K+(-104).*Du.^2.* ...
  K.^2+16.*Du.^3.*K.^3))).*ubar.^3+(alpha.^2.*C2.*Du.*((-2)+(-1).* ...
  Du.*(80+29.*Dv).*K+4.*Du.^2.*(9+8.*Dv).*K.^2)+2.*Du.*K.*(40+(-4).* ...
  Du.*(29+33.*Dv).*K+4.*Du.^2.*((-18)+22.*Dv+23.*Dv.^2).*K.^2+3.* ...
  Du.^3.*Dv.*(26+9.*Dv).*K.^3+(-15).*Du.^4.*Dv.^2.*K.^4)+(-2).* ...
  alpha.*(C2.*(2+Du.*(60+13.*Dv).*K+(-1).*Du.^2.*(108+158.*Dv+25.* ...
  Dv.^2).*K.^2+2.*Du.^3.*Dv.*(32+29.*Dv).*K.^3+3.*Du.^4.*Dv.^2.* ...
  K.^4)+Du.*(2.*((-7)+(-87).*Du.*K+25.*Du.^2.*K.^2+18.*Du.^3.*K.^3)+ ...
  Dv.*((-1)+(-45).*Du.*K+93.*Du.^2.*K.^2+50.*Du.^3.*K.^3)))).* ...
  ubar.^4+Du.*((-1).*alpha.*C2.*(2+(-52).*Du.*K+72.*Du.^2.*K.^2+Dv.* ...
  (1+(-13).*Du.*K+61.*Du.^2.*K.^2+4.*Du.^3.*K.^3))+2.*((-2)+2.*Du.*( ...
  (-13)+Dv).*K+2.*Du.^2.*(35+27.*Dv).*K.^2+2.*Du.^3.*(18+7.*Dv).* ...
  K.^3+(-9).*Du.^4.*Dv.*K.^4+C2.*K.*(8+(-36).*Du.*(1+Dv).*K+4.* ...
  Du.^2.*Dv.*(8+7.*Dv).*K.^2+3.*Du.^3.*Dv.^2.*K.^3))).*ubar.^5+C2.* ...
  Du.*(2+(-2).*Du.*(4+Dv).*K+Du.^2.*(36+29.*Dv).*K.^2+4.*Du.^3.*Dv.* ...
  K.^3).*ubar.^6);

%Initial magnitude of the perturbation
P0=0.01;

%PDE part
Tmax = 10000;
m=0;
x=linspace(a,b,N);
t=linspace(0,Tmax,Tmax+1);
%setting parameters for PDE
param1=[Du, Dv, Dw, alpha, beta,chi,eps];
param2=[wbar, ubar, vbar, P0, Q, R,wk];
%solving PDE using pdepe
sol=pdepe(m,@(x,t,u,dudx)pdefun(x,t,u,dudx,param1),@(x)pdeic(x,param2),@pdebc,x,t);
u1=sol(:,:,1);
u2=sol(:,:,2);
u3=sol(:,:,3);

%ODE part
t0=0.0;
tfinal=Tmax;
%p0=[sqrt(-D11*eps/D13)]; steady state
p0=[P0];
P=[eps,D11,D13];
[tamp,Uamp] = ode15s(@(t,Uamp)WeakOdes(t,Uamp,P),[t0 tfinal],p0);
Uweak=zeros(N-1,length(tamp));

%Computing RMS for ODE solution
for i=1:N-1
        for k=1:length(tamp)
            Uweak(i,k)=Uamp(k)*cos(x(i)*wk)+Uamp(k)^2*cos(2*x(i)*wk)*C2*(-1/36);%+Uamp(k)^3*cos(3*(i)*wk)*C3*(-1/576);
        end
end

UweakS=zeros(1,length(tamp));
for i=1:length(tamp)
    UweakS(i)=rms(Uweak(:,i));
end

%plotting rms. You need to run this code multiple types and save rms if you
%want to compare multiple initial conditions.
figure()
hold on
smpl=500;
plot(tamp,UweakS,'k','LineWidth',2)
plot(t,rms(u1'-ubar),'r-o','MarkerIndices',1:smpl:length(rms(u1'-ubar)),'MarkerFaceColor','r')%,'LineWidth',1)
xlabel('t')
ylabel('A_{amp}(t)')
hold off

%plotting the whole PDE solution to observe hotspot emergence
figure()
tiledlayout(1,3)

nexttile
plot1=imagesc(x,t,u1)
%set(plot1,'Linestyle','none')
%set(gca,'xtick',[])
title('u_1')
xlabel('x')
ylabel('t')
colorbar

nexttile
plot2=imagesc(x,t,u2)
%set(plot2,'Linestyle','none')
title('u_2')
xlabel('x')
ylabel('t')
colorbar

nexttile
plot3=imagesc(x,t,u3)
%set(plot3,'Linestyle','none')
title('u_3')
xlabel('x')
ylabel('t')
colorbar

%pdepe function
function [c,f,s]=pdefun(x,t,u,dudx,P)
    Du=P(1); Dv=P(2); Dw=P(3); alpha=P(4); beta=P(5); chi=P(6); eps=P(7); 
    c=[1;1;1];
    f=[Du*dudx(1);Dv*dudx(2)-2*u(2)*dudx(1)/u(1);Dw*dudx(3)-(chi-eps)*u(3)*dudx(1)/u(1)];
    s=[-u(1)+u(1)*u(2)+alpha;-u(1)*u(2)+beta-u(3)*u(2);0];
end

%IC for pdepe
function u0=pdeic(x,P)
wbar=P(1); ubar=P(2); vbar=P(3); P0=P(4); Q=P(5); R=P(6); wk=P(7);
funu0 = ubar+P0*cos(x*wk);% initial u function
funv0 = vbar+P0*Q*cos(x*wk); % initial v function 
funw0 = wbar+P0*R*cos(x*wk);
%u0=[ubar+rand(1,1)/(3);vbar+rand(1,1)/(3);wbar+rand(1,1)/(3)];
u0=[funu0;funv0;funw0];
end

%BC for pdepe
function [pl,ql,pr,qr]=pdebc(xl,ul,xr,ur,t)
    pl=[0;0;0];
    ql=[-1;-1;-1];
    pr=[0;0;0];
    qr=[1;1;1];
end

%ODE function
function dpdt = WeakOdes(t,Uamp,p)
u=Uamp(1);
eps=p(1);
C2=p(2);
C3=p(3);
dpdt=[C2.*eps.*u+C3.*u.^3];
end
