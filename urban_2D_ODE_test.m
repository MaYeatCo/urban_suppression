%parameters
Dw=2.5;%1.9928608732968183 <- this separates between super (below) and sub (above)
Dv=Dw;
ubar=0.5;
alpha=0.05;
Du=(1/32).*Dw.^(-2).*ubar.^(-1).*(16.*alpha.*Dw+(-8).*alpha.*Dw.^2+ ...
  2.*alpha.*ubar+(-16).*Dw.*ubar+(-1).*alpha.*Dw.*ubar+(-2).* ...
  ubar.^2+Dw.*ubar.^2)+(1/32).*(Dw.^(-4).*ubar.^(-2).*(512.* ...
  alpha.^2.*Dw.^2+(-256).*alpha.^2.*Dw.^3+64.*alpha.^2.*Dw.*ubar+( ...
  -1024).*alpha.*Dw.^2.*ubar+(-64).*alpha.^2.*Dw.^2.*ubar+256.* ...
  alpha.*Dw.^3.*ubar+16.*alpha.^2.*Dw.^3.*ubar+4.*alpha.^2.*ubar.^2+ ...
  (-128).*alpha.*Dw.*ubar.^2+(-4).*alpha.^2.*Dw.*ubar.^2+512.* ...
  Dw.^2.*ubar.^2+96.*alpha.*Dw.^2.*ubar.^2+alpha.^2.*Dw.^2.*ubar.^2+ ...
  (-16).*alpha.*Dw.^3.*ubar.^2+(-8).*alpha.*ubar.^3+64.*Dw.*ubar.^3+ ...
  8.*alpha.*Dw.*ubar.^3+(-32).*Dw.^2.*ubar.^3+(-2).*alpha.*Dw.^2.* ...
  ubar.^3+4.*ubar.^4+(-4).*Dw.*ubar.^4+Dw.^2.*ubar.^4)).^(1/2);

beta = (-1).*Du.^(-1).*ubar.^(-2).*((-2).*alpha.^2+(-1).*alpha.^2.*Dv+4.* ...
  alpha.*ubar+alpha.*Dv.*ubar+(-8).*alpha.*Du.*Dv.*ubar+(-2).* ...
  ubar.^2+8.*Du.*Dv.*ubar.^2);

vbar= 1-alpha/ubar;
wbar = ubar*(beta/(ubar-alpha)-1);

K=(1/2).*Du.^(-1).*Dv.^(-1).*ubar.^(-1).*((-1).*alpha+ubar).^(-1).*( ...
  alpha.^2.*(2+Dv)+(-1).*alpha.*(4+Dv).*ubar+(2+(-1).*beta.*Du).* ...
  ubar.^2);
chi=Dw.*(alpha+beta+(-1).*ubar).^(-1).*(alpha+Du.*Dv.*K.^2+(-1).*ubar+ ...
  (-1).*alpha.*beta.*((-1).*alpha+ubar).^(-1));

%coefficients for ODE
C1=Du.^(-2).*Dv.^(-1).*K.^(-2).*ubar.^(-2).*((-1).*alpha+ubar).^(-1) ...
  .*(alpha.*(2+Dv)+2.*((-1)+Du.*Dv.*K).*ubar+Du.*ubar.^2).^(-1).*( ...
  alpha.^3.*(2+Dv).^2.*(1+8.*Du.*K)+alpha.^2.*(2+Dv).*((-4)+(-2).* ...
  Du.*(18+Dv).*K+Du.^2.*(8+25.*Dv).*K.^2).*ubar+alpha.*(4+8.*Du.*(6+ ...
  Dv).*K+(-1).*Du.^2.*(32+76.*Dv+13.*Dv.^2).*K.^2+20.*Du.^3.*Dv.*(1+ ...
  Dv).*K.^3+alpha.*Du.*(2+Dv).*(1+8.*Du.*K)).*ubar.^2+Du.*(K.*((-8)+ ...
  2.*Du.*(8+9.*Dv).*K+(-10).*Du.^2.*Dv.*(2+Dv).*K.^2+3.*Du.^3.* ...
  Dv.^2.*K.^3)+alpha.*(4.*Du.*K.*((-5)+2.*Du.*K)+Dv.*(1+(-4).*Du.*K+ ...
  9.*Du.^2.*K.^2))).*ubar.^3+Du.*((-2)+2.*Du.*(2+Dv).*K+(-1).* ...
  Du.^2.*(8+3.*Dv).*K.^2+2.*Du.^3.*Dv.*K.^3).*ubar.^4);
C2=C1;
C3=2.*Du.^(-2).*Dv.^(-1).*K.^(-2).*ubar.^(-2).*((-1).*alpha+ubar).^( ...
  -1).*(alpha.*(2+Dv)+2.*((-1)+Du.*Dv.*K).*ubar+Du.*ubar.^2).^(-1).* ...
  (alpha.^3.*(2+Dv).^2.*(1+4.*Du.*K)+alpha.^2.*(2+Dv).*((-4)+2.*Du.* ...
  ((-8)+Dv).*K+Du.^2.*(4+13.*Dv).*K.^2).*ubar+alpha.*(4+(-4).*Du.*(( ...
  -4)+Dv).*K+(-1).*Du.^2.*(16+32.*Dv+Dv.^2).*K.^2+12.*Du.^3.*Dv.*(1+ ...
  Dv).*K.^3+alpha.*Du.*(2+Dv).*(1+4.*Du.*K)).*ubar.^2+Du.*(alpha.*( ...
  Dv+5.*Du.^2.*Dv.*K.^2+4.*Du.*K.*((-2)+Du.*K))+Du.*K.^2.*(8+Dv.*(2+ ...
  (-12).*Du.*K)+Du.*Dv.^2.*K.*((-2)+3.*Du.*K))).*ubar.^3+Du.*((-2)+ ...
  2.*Du.*Dv.*K+Du.^2.*((-4)+Dv).*K.^2+2.*Du.^3.*Dv.*K.^3).*ubar.^4);


U1=(-1).*K.*((-1).*alpha+ubar).*(alpha.*(2+Dv)+2.*((-1)+Du.*Dv.*K).* ...
  ubar+Du.*ubar.^2).*((-1).*alpha.^2.*(2+Dv)+alpha.*(2+(-1).*(2+Dv) ...
  .*Dw.*K+Du.*((-2).*Dv+Dw).*K).*ubar+(-1).*(alpha.*Du+K.*(Du.^2.* ...
  Dv.*K+Dw.*((-2)+(-1).*Du.^2.*K+Du.*Dv.*K))).*ubar.^2+Du.*ubar.^3) ...
  .^(-1);
U2=(1/72).*Dw.*K.*ubar.^(-1).*((-1).*alpha+ubar).^(-2).*(alpha.*(2+ ...
  Dv)+2.*((-1)+Du.*Dv.*K).*ubar+Du.*ubar.^2).^(-1).*((-1).* ...
  alpha.^2.*(2+Dv)+alpha.*(2+(-1).*(2+Dv).*Dw.*K+Du.*((-2).*Dv+Dw).* ...
  K).*ubar+(-1).*(alpha.*Du+K.*(Du.^2.*Dv.*K+Dw.*((-2)+(-1).*Du.^2.* ...
  K+Du.*Dv.*K))).*ubar.^2+Du.*ubar.^3).^(-1).*(18.*alpha.^4.*(2+Dv) ...
  .^2.*(4+37.*Du.*K)+(-1).*alpha.^3.*(2+Dv).*(alpha.*C2.*(2+Dv).*(1+ ...
  2.*Du.*K)+18.*(20+224.*Du.*K+(-44).*Du.^2.*K.^2+Dv.*(2+40.*Du.*K+( ...
  -119).*Du.^2.*K.^2))).*ubar+alpha.^2.*(alpha.*(2+Dv).*(18.*Du.*(4+ ...
  37.*Du.*K)+C2.*(6+Dv+4.*Du.*K+(-5).*Du.*Dv.*K+4.*Du.^2.*K.^2+80.* ...
  Du.^2.*Dv.*K.^2))+18.*(Du.*Dv.^2.*K.*(16+(-149).*Du.*K+108.* ...
  Du.^2.*K.^2)+4.*(8+123.*Du.*K+(-57).*Du.^2.*K.^2+2.*Du.^3.*K.^3)+ ...
  2.*Dv.*(4+104.*Du.*K+(-283).*Du.^2.*K.^2+64.*Du.^3.*K.^3))).* ...
  ubar.^2+(-1).*alpha.*(alpha.^2.*C2.*Du.*(2+Dv).*(1+2.*Du.*K)+(-18) ...
  .*((-8)+(-4).*Du.*(58+13.*Dv).*K+2.*Du.^2.*(96+184.*Dv+31.*Dv.^2) ...
  .*K.^2+(-2).*Du.^3.*(8+96.*Dv+57.*Dv.^2).*K.^3+Du.^4.*Dv.*(18+31.* ...
  Dv).*K.^4)+alpha.*((-18).*Du.*((-4)+(-158).*Du.*K+44.*Du.^2.*K.^2+ ...
  Dv.*(2+(-52).*Du.*K+45.*Du.^2.*K.^2))+C2.*(Du.*Dv.^2.*K.*((-7)+ ...
  166.*Du.*K+(-172).*Du.^2.*K.^2)+12.*(1+(-2).*Du.*K+2.*Du.^2.*K.^2) ...
  +(-4).*Dv.*((-1)+9.*Du.*K+(-124).*Du.^2.*K.^2+4.*Du.^3.*K.^3)))).* ...
  ubar.^3+(alpha.^2.*C2.*Du.*(2+(-3).*Du.*Dv.*K+4.*Du.^2.*(1+21.*Dv) ...
  .*K.^2)+18.*Du.*K.*(40+(-4).*Du.*(13+21.*Dv).*K+4.*Du.^2.*(2+16.* ...
  Dv+11.*Dv.^2).*K.^2+(-9).*Du.^3.*Dv.*(2+Dv).*K.^3+5.*Du.^4.* ...
  Dv.^2.*K.^4)+2.*alpha.*(C2.*(2+(-1).*Du.*(20+11.*Dv).*K+Du.^2.*( ...
  12+250.*Dv+43.*Dv.^2).*K.^2+(-2).*Du.^3.*Dv.*(8+81.*Dv).*K.^3+9.* ...
  Du.^4.*Dv.^2.*K.^4)+9.*Du.*(2.*((-5)+55.*Du.*K+(-37).*Du.^2.*K.^2+ ...
  2.*Du.^3.*K.^3)+Dv.*((-3)+33.*Du.*K+(-49).*Du.^2.*K.^2+14.*Du.^3.* ...
  K.^3)))).*ubar.^4+Du.*(18.*(6+(-2).*Du.*(13+3.*Dv).*K+2.*Du.^2.*( ...
  15+11.*Dv).*K.^2+(-2).*Du.^3.*(2+Dv).*K.^3+3.*Du.^4.*Dv.*K.^4)+( ...
  -2).*C2.*K.*((-8)+(-4).*Du.^2.*Dv.*(2+19.*Dv).*K.^2+9.*Du.^3.* ...
  Dv.^2.*K.^3+4.*Du.*(K+21.*Dv.*K))+alpha.*C2.*(2+12.*Du.*K+(-8).* ...
  Du.^2.*K.^2+Dv.*(1+3.*Du.*K+(-171).*Du.^2.*K.^2+4.*Du.^3.*K.^3))) ...
  .*ubar.^5+C2.*Du.*((-2)+2.*Du.*((-4)+Dv).*K+Du.^2.*(4+87.*Dv).* ...
  K.^2+(-4).*Du.^3.*Dv.*K.^3).*ubar.^6);
U3=(1/4).*Dw.*K.*ubar.^(-1).*((-1).*alpha+ubar).^(-2).*(alpha.*(2+Dv) ...
  +2.*((-1)+Du.*Dv.*K).*ubar+Du.*ubar.^2).^(-1).*((-1).*alpha.^2.*( ...
  2+Dv)+alpha.*(2+(-1).*(2+Dv).*Dw.*K+Du.*((-2).*Dv+Dw).*K).*ubar+( ...
  -1).*(alpha.*Du+K.*(Du.^2.*Dv.*K+Dw.*((-2)+(-1).*Du.^2.*K+Du.*Dv.* ...
  K))).*ubar.^2+Du.*ubar.^3).^(-1).*(2.*alpha.^4.*(2+Dv).^2.*(4+17.* ...
  Du.*K)+(-1).*alpha.^3.*(2+Dv).*(alpha.*C3.*(2+Dv).*(1+2.*Du.*K)+ ...
  Dv.*(4+8.*Du.*K+(-118).*Du.^2.*K.^2)+8.*(5+23.*Du.*K+(-6).*Du.^2.* ...
  K.^2)).*ubar+alpha.^2.*(2.*(Du.^2.*Dv.^2.*K.^2.*((-41)+64.*Du.*K)+ ...
  4.*(8+43.*Du.*K+(-29).*Du.^2.*K.^2+2.*Du.^3.*K.^3)+Dv.*(8+36.*Du.* ...
  K+(-234).*Du.^2.*K.^2+80.*Du.^3.*K.^3))+(-1).*alpha.*(2+Dv).*((-2) ...
  .*Du.*(4+17.*Du.*K)+C3.*((-6)+(-8).*Du.*K+2.*Du.^2.*K.^2+Dv.*((-1) ...
  +3.*Du.*K+3.*Du.^2.*K.^2)))).*ubar.^2+(-1).*alpha.*(16+8.*Du.*(16+ ...
  Dv).*K+(-4).*Du.^2.*(44+56.*Dv+7.*Dv.^2).*K.^2+4.*Du.^3.*(8+54.* ...
  Dv+19.*Dv.^2).*K.^3+(-2).*Du.^4.*Dv.*(14+27.*Dv).*K.^4+alpha.^2.* ...
  C3.*Du.*(2+Dv).*(1+2.*Du.*K)+2.*alpha.*Du.*(4+58.*Du.*K+(-24).* ...
  Du.^2.*K.^2+Dv.*((-2)+12.*Du.*K+(-25).*Du.^2.*K.^2))+alpha.*C3.*( ...
  12+(-12).*Du.^2.*K.^2+Du.*Dv.^2.*K.*((-5)+9.*Du.*K)+4.*Dv.*(1+(-5) ...
  .*Du.*K+Du.^2.*K.^2+2.*Du.^3.*K.^3))).*ubar.^3+(alpha.^2.*C3.*Du.* ...
  (2+(-1).*Du.*((-4)+Dv).*K+Du.^2.*((-2)+Dv).*K.^2)+2.*Du.*K.*(8+( ...
  -20).*Du.*(1+Dv).*K+4.*Du.^2.*(2+7.*Dv+3.*Dv.^2).*K.^2+(-1).* ...
  Du.^3.*Dv.*(14+5.*Dv).*K.^3+5.*Du.^4.*Dv.^2.*K.^4)+alpha.*(C3.*(4+ ...
  (-2).*Du.*(8+7.*Dv).*K+4.*Du.^2.*((-3)+8.*Dv+3.*Dv.^2).*K.^2+(-4) ...
  .*Du.^3.*Dv.*((-4)+3.*Dv).*K.^3+(-3).*Du.^4.*Dv.^2.*K.^4)+2.*Du.*( ...
  (-10)+30.*Du.*K+(-34).*Du.^2.*K.^2+4.*Du.^3.*K.^3+Dv.*((-3)+13.* ...
  Du.*K+(-9).*Du.^2.*K.^2+14.*Du.^3.*K.^3)))).*ubar.^4+Du.*(C3.*K.*( ...
  8+4.*Du.*(1+(-5).*Dv).*K+4.*Du.^2.*Dv.*((-2)+3.*Dv).*K.^2+3.* ...
  Du.^3.*Dv.^2.*K.^3)+2.*(6+(-6).*Du.*(1+Dv).*K+2.*Du.^2.*(5+Dv).* ...
  K.^2+(-2).*Du.^3.*(2+Dv).*K.^3+3.*Du.^4.*Dv.*K.^4)+alpha.*C3.*(2+ ...
  4.*Du.*K+4.*Du.^2.*K.^2+Dv.*(1+Du.*K+(-9).*Du.^2.*K.^2+(-2).* ...
  Du.^3.*K.^3))).*ubar.^5+2.*C3.*Du.*((-1)+Du.*((-2)+Dv).*K+Du.^2.*( ...
  (-1)+4.*Dv).*K.^2+Du.^3.*Dv.*K.^3).*ubar.^6);
%due to symmetry y equation mimics x equation
V1=U1;
V2=U2;
V3=U3;

Tmax = 20000;
wk=sqrt(K);
eps=-0.01:0.002:0.01;%set range for epsilon here
UampEnd=zeros(1,length(eps));


a = 0; % left end of the interval
b = 4*pi/wk;  % right end of the interval
L = b-a;
Np=101;
x_cell=linspace(0,L,Np-1);
y_cell=linspace(0,L,Np-1);

t0=0.0;
tfinal=Tmax;
%we use loop to get the needed rms array
for l=1:length(eps)
%the initial magnitude is chosen to be close to the steady state
%P0=(eps(l)<0)*0.1+(eps(l)>=0)*0.9*sqrt(-eps(l)*U1/(U2+U3));
%P0=(eps(l)>0)*0.1+(eps(l)<=0)*0.5*sqrt(-eps(l)*U1/(U2+U3));
%P0=0;

%setting the ODE system
P0=(eps(l)>0)*0.1+(eps(l)<=0)*1*sqrt(-eps(l)*U1/(U2+U3));
p0=[P0;P0];
P=[eps(l),U1,U2,U3,V1,V2,V3];
[t,Uamp] = ode89(@(t,Uamp)WeakOdes(t,Uamp,P),[t0 tfinal],p0);

%note you need to solve PDE part first to obtain the grid points where you
%compute RMS. otherwise use the standard grid points
if exist('X','var')==0
   X=[x_cell;y_cell];
end
%computing rms
Uweak=zeros(length(X),length(t));
for i=1:length(X)
        for k=1:length(t)
            Uweak(i,k)=Uamp(k,1)*cos(X(1,i)*wk)+Uamp(k,2)*cos(X(2,i)*wk)+C1*Uamp(k,1)^2*cos(X(1,i)*wk*2)*(-1/36)...
                +C2*Uamp(k,2)^2*cos(X(1,i)*wk*2)*(-1/36)+C3*Uamp(k,1)*Uamp(k,2)*cos(X(1,i)*wk)*cos(X(2,i)*wk)*(-1/2);
        end
end
UweakS=rms(Uweak);
UampEnd(l)=UweakS(end);
end

%plotting rms. You need to run the test for PDE to plot UsimEnd. Repeat and
%save if you want to try multiple initial conditions.
figure()
hold on
plot(eps,UampEnd,'k--','Linewidth',2);
%plot(eps,UsimEnd,'b-o','MarkerFaceColor','b')
xlim([eps(1) eps(end)])
ylabel('A_{amp}(t_{final})')
xlabel('\epsilon')
hold off

%ODE function 
function dpdt = WeakOdes(t,Uamp,p)
u=Uamp(1);
v=Uamp(2);
eps=p(1);
u1=p(2);
u2=p(3);
u3=p(4);
v1=p(5);
v2=p(6);
v3=p(7);
dpdt=[u.*u1.*eps+u2.*u.^3+u3.*v.^2.*u;
    v.*v1.*eps+v2.*v.^3+v3.*u.^2.*v];
end